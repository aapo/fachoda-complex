<!DOCTYPE html>
<html>
<head>
  <meta charset='latin1'>

  <title>rixed/fachoda-complex @ GitHub</title>

  <style type="text/css">
    body {
      margin-top: 1.0em;
      background-color: #ab8cb8;
      font-family: Helvetica, Arial, FreeSans, san-serif;
      color: #000000;
    }
    #container {
      margin: 0 auto;
      width: 700px;
    }
    h1 { font-size: 3.8em; color: #547347; margin-bottom: 3px; }
    h1 .small { font-size: 0.4em; }
    h1 a { text-decoration: none }
    h2 { font-size: 1.5em; color: #547347; }
    h3 { text-align: center; color: #547347; }
    a { color: #547347; }
    .description { font-size: 1.2em; margin-bottom: 30px; margin-top: 30px; font-style: italic;}
    .download { float: right; }
    pre { background: #000; color: #fff; padding: 15px;}
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    .footer { text-align:center; padding-top:30px; font-style: italic; }
	.code { font-family: mono; color: #111; }
	div.code { margin-left: 5em; }
  </style>
	<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-28394533-1']);
	_gaq.push(['_trackPageview']);
	(function() {
	 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	 })();
  (function() {
      var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
      po.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();

	</script>
</head>

<body>
  <a href="https://github.com/rixed/fachoda-complex"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" /></a>

  <div id="container">

    <div class="download">
      <a href="https://github.com/rixed/fachoda-complex/zipball/master">
        <img border="0" width="90" src="https://github.com/images/modules/download/zip.png"></a>
      <a href="https://github.com/rixed/fachoda-complex/tarball/master">
        <img border="0" width="90" src="https://github.com/images/modules/download/tar.png"></a>
    </div>

    <h1><a href="https://github.com/rixed/fachoda-complex">Fachoda-Complex</a>
      <span class="small">by <a href="https://github.com/rixed">rixed</a></span></h1>

    <div class="description">
      Restoring a vintage flight simulator
    </div>

    
      <p>Some restore antique furnitures or old cars for a hobby.  I am 
restoring a vintage piece of <i>code</i>, a small game that was quickly 
put together at the end of the former century then had its bits abandoned
to rust. The original author is long gone and his ideas and thoughts
forgotten. He was the me of 12 years ago.</p>

	<p>I've always wanted to come up with a follow up but even if it was
started on several occasions nothing was ever achieved.  Being not
interested in games nor 3D rendering any more, the only second version of
it I can seriously envision now is to bring back to life this rusty piece
of software.</p>

	<p>In addition to bringing peace to my conscience I will also 
probably gain a few good laughs rediscovering the old bugs and 
non portable monstrosities I committed back then.</p>
    
<h2>Day 1</h2>
<img src="http://www.utubefree.com/wp-content/uploads/2011/10/splendid-abandoned-planes-001.jpg"/>

<p>I set up this page to share the fun of this restoration process.
</p><p>
The first step of this process consisted of the replacement or mere
removal of all assembly code (<a href="https://github.com/rixed/fachoda-complex/commit/4d2045f7320bd7e6a0dbbd2df89fc8f70919318d">the commit</a>).
This code was used mainly for the rendering
so I did not expect anything to show properly after this move.
</p><p>
After hundreds of dreadful warnings the SDL version of the game compiled
(the other versions were jettisoned one commit earlier). When you think about it,
it means that SDL is still retrocompatible with code written more than 
10 years ago. That's what I call commitment !
</p><p>
So, since I was able to run the game then I just did,
and... the game menu appeared, in all its past glory, colors and animations!
</p>
<img src="menu1.png"/>
<p>
So, despite all the rendering code that I just removed, there was enough
rendering functions still functional to give life to the menu.
There must have been a lot of redundant code in there.
</p><p>
If you are like me, you pay a lot of attention to the game menu. Lots of
them are bugged or otherwise unpleasant because I suppose game authors
enjoy writing the game engine more than its menu. But I think a good game
menu says it all about authors' (lack of) care to details. The only other
game I ever worked on also have an animated menu (see
<a href="http://www.nongnu.org/ensemblist/index_en.html">here</a>).
Some games I remember the menus but not the actual games.
I could watch some of them for hours.
</p><p>
But here I was curious about the game, so I hit the "Go!" button.
The game started to load but crashed before displaying it's first ingame
picture.
</p><p>
Well, it had to be expected.
</p><p>
The <a href="https://github.com/rixed/fachoda-complex/commit/3c9d121eba7372face78f2c565fd131167120ed5">fix</a>
was hopefully trivial. Embarrassingly trivial actually. A quite look around this line
revealed many other potential variants for the same bug. Ouch.
For now, let's fix this one which is causing a segfault and try again.
</p><p>
Compile... run... "Go!"... and then, the game!
</p><p>
As expected, the rendering is quite acid and not as originally intended.
From the background color of this page you probably already guessed
that my best friend in design is the random generator, but in my memories
(and Google seams to agree) the game colors where not that tripping.
It looks like the ground colors are wrong RGB ordering, and that we are
somewhat below some kind of ground (but the blue sky can be seen from
time to time and is indeed blue). Also, the lighting results in many small
white stripes, which is nice but no, thanks.
</p><p>
Anyway, the engine runs already so that's not too bad.
</p>

<img src="ingame1.png"/>
<p>
Obviously there's still a lot of work to do before it's finished (and put to sleep
again for 12 more years), but it's a good start.
</p><p>
To see this old program running again is a lot like when you find by accident an
old toy you owned or an old drawing you've made as a kid. It feels at the same time warm
and distant, familiar but alien, desirable yet worthless.
</p>


<h2>Day 2</h2>

	<p>Returning to a piece of code you wrote many years ago is indeed a humbling
experience; even more than I expected. The code is odd in so many obvious ways
I can no longer understand why I was somewhat proud of it at that time to a
point were I was used to put a link to it on my resumes. I suppose I was proud
of the numerous tricks used in the engine, and not on the code itself. But the
tricks are hard to spot while the code is blatantly awfull.</p>

	<p>This is something that often strike me: how with age we become more and
more passionate about how the code looks rather than what it does and how. I
suspect the younger me was right to ignore suchh issues as naming, indentation,
code partitioning, etc, and ficus on the algorithms and optimisations instead; but
on the other hand this is a kind of confidence that only ignorance can brings.</p>

	<p>Anyway, I reworked somewhat the landscape generation code, removing dead code
and fixing things along the way. Most importantly, I documented how this part works.
The landscape is basically a map of 128x128 bytes, giving the height at that location.
To each of these tile is added a sub-heighfield of 16x16 that add higher frequency
signal. The nice trick is that there are only 10 of these sub-heighfield possible,
and we merely have another 128x128 bytes array to associate a tile to one of these
predefined sub-heighfield.</p>

	<p>Then, we have another array of 256 colors that gives us the color of any
landscape point from its altitude. Then comes the lighting, for with we need another
10 arrays of 16x16 bytes, giving the relative lightening of this particular sub-tile
relative to the underlying tile (sloppy, but the eye won't notice and this avoids
many dot products). Each polygon of the landscape is then &quot;gouraued&quot;.</p>

	<p>The whole landscape thus fit into:<br/>
	128*128&nbsp;+&nbsp;10*(16*16)&nbsp;+&nbsp;128*128&nbsp;+&nbsp;256&nbsp;+&nbsp;10*(16*16)&nbsp;=&nbsp;37Kbyte.
</p>

	<p>Regarding the data structures used in the game, I noticed that very few structs
were used. C is here used very much like a high level assembly, with very few custom
types. For instance, each of the afore-mentioned arrays are allocated separately.
Today I would without hesitation do this:</p>

<div class="code">
struct map *map = malloc(128*128*sizeof(*map));
</div>

<p>... where <span class="code">struct map</span> would have a z field, a submap field,
etc... But here we have all these fields allocated separately in distinct arrays. In
other words, data are regrouped by usage instead of by "object". This is less easy to
read but the code may be more cache friendly this way. I will probably not resist the
temptation to rewrite this object-style, though.</p>

<p>So after a few bugfixes, here is how it looks:</p>
<img src="ingame2.png"/>
<p>As you can see acid colors are gone, but I need to get back this Gouraud shading
that was lost when ditching MMX code.</p>

    <h2>Download</h2>
    <p>
      You can download this project in either
      <a href="https://github.com/rixed/fachoda-complex/zipball/master">zip</a> or
      <a href="https://github.com/rixed/fachoda-complex/tarball/master">tar formats.
    </p>
    <p>You can also clone the project with <a href="http://git-scm.com">Git</a>
      by running:
      <pre>$ git clone git://github.com/rixed/fachoda-complex</pre>
    </p>

    <div class="footer">
      get the source code on GitHub : <a href="https://github.com/rixed/fachoda-complex">rixed/fachoda-complex</a>
    </div>

<g:plusone size="small"></g:plusone>

  </div>

</body>
</html>
